# HmNewVersionDownloader の問題点

このプロジェクトには、安定性と保守性の観点から、いくつかの潜在的な問題が存在します。

## 1. 秀丸公式サイトのHTML構造への強い依存

本ツールは、秀丸エディタの公式サイトから特定のHTMLページをダウンロードし、その内容を正規表現で解析（スクレイピング）することで、最新版の実行ファイルURLを取得しています。

- **問題点:**
  - `https://hide.maruo.co.jp/software/hidemaru.html` というURLがソースコード内にハードコーディングされています。公式サイトのURL構造が変更された場合、ツールは機能しなくなります。
  - HTML内の特定のパターンを正規表現でマッチングさせているため、サイトのデザイン変更、HTMLタグの構造変更、クラス名やIDの変更など、些細な修正でもURLが取得できなくなる可能性が非常に高いです。これはWebスクレイピングに共通する脆弱性です。

- **改善案:**
  - 可能であれば、公式サイトが提供するRSSフィードやAPIなどを利用する方式に変更することが望ましいです。もし提供されていない場合は、スクレイピング処理の脆弱性を許容した上で、エラーハンドリングを強化する必要があります。

## 2. 外部実行ファイル `7z.exe` への依存

ダウンロードしたアーカイブファイルの展開に、`7z.exe` という外部コマンドを利用しています。

- **問題点:**
  - ユーザーのPCに `7z.exe` がインストールされていない、あるいは環境変数のパスが通っていない場合、アーカイブの展開に失敗します。
  - 実行ファイル `HmNewVersionDownloader.exe` と同じディレクトリに `7z.dll` と `7z.exe` が同梱されていますが、この配置が崩れると動作しません。

- **改善案:**
  - .NET標準の `System.IO.Compression.ZipFile` クラスや、サードパーティのライブラリ（例: `SharpZipLib`）を利用して、C#のコード内で完結する展開処理に置き換えることで、外部プロセスへの依存をなくすことができます。

## 3. 不十分なエラー処理とロールバック機能の欠如

エラーハンドリングが `try-catch` によるコンソール出力に留まっています。

- **問題点:**
  - ダウンロードの失敗、ファイルの展開失敗、ファイルのコピー失敗などが発生した場合、ユーザーにはエラーが起きたことしか伝わりません。マクロ経由で実行された場合、コンソール出力が見えず、何が起きたのか把握することが困難です。
  - ファイルの更新処理の途中でエラーが発生した場合、秀丸エディタのインストールフォルダが中途半端な状態（新旧ファイルが混在する、ファイルが破損するなど）で放置されてしまいます。元のバージョンに復元するロールバック機能がありません。

- **改善案:**
  - エラー発生時には、ユーザーに分かりやすい形で（ダイアログボックス等で）エラー内容を通知する仕組みを設けるべきです。
  - ファイルを更新する前に、現在の秀丸のファイルをバックアップし、処理が失敗した場合にはバックアップからリストアするロールバック機構を実装することが望ましいです。

## 4. 不安定なプロセス終了処理

秀丸エディタのプロセスを終了させるために、固定時間(`Task.Delay`)の待機処理を入れています。

- **問題点:**
  - PCのスペックや負荷状況によっては、指定時間内にプロセスが終了しきらない可能性があります。その場合、まだプロセスが起動しているにもかかわらずファイルの更新処理が実行され、ファイルのロックにより失敗する原因となります。

- **改善案:**
  - `Process.WaitForExit()` メソッドを使い、プロセスの終了を確実に待機する方式に変更するべきです。最初に正常な終了処理を試み、タイムアウトした場合は強制終了に移行し、その終了を待つ、という段階的な処理がより堅牢です。

## 5. 設定の柔軟性の欠如

URLや外部コマンドのパスなどがソースコード内にハードコーディングされており、柔軟な設定変更ができません。

- **問題点:**
  - 将来的にURLが変更された場合や、`7z.exe` を別の場所にあるものを使いたい場合に、ソースコードを修正して再コンパイルする必要があります。

- **改善案:**
  - 設定ファイル（例: `config.json` や `app.config`）を導入し、URL、各種パス、正規表現パターンなどを外部から設定できるようにすることで、保守性が向上します。
